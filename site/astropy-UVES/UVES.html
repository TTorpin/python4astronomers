<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Astropy II: Analyzing UVES Spectroscopy &mdash; Python4Astronomers 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/bootstrap-astropy.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/sidebar.js"></script>
    <link rel="top" title="Python4Astronomers 2.0 documentation" href="../index.html" />
    <link rel="next" title="Online Astronomy and the virtual observatory" href="../vo/vo.html" />
    <link rel="prev" title="Celestial Coordinates" href="../astropy/coordinates.html" />
<link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:200,600' rel='stylesheet' type='text/css'>
<script type="text/javascript" src="../_static/copybutton.js"></script>

<script type="text/javascript"> 
$(document).ready(function(){

$(".flip0").click(function(){
    $(".panel0").slideToggle("normal");
  });

$(".flip1").click(function(){
    $(".panel1").slideToggle("normal");
  });

$(".flip2").click(function(){
    $(".panel2").slideToggle("normal");
  });

$(".flip3").click(function(){
    $(".panel3").slideToggle("normal");
  });

$(".flip4").click(function(){
    $(".panel4").slideToggle("normal");
  });

$(".flip5").click(function(){
    $(".panel5").slideToggle("normal");
  });

$(".flip6").click(function(){
    $(".panel6").slideToggle("normal");
  });

$(".flip7").click(function(){
    $(".panel7").slideToggle("normal");
  });

$(".flip8").click(function(){
    $(".panel8").slideToggle("normal");
  });

$(".flip9").click(function(){
    $(".panel9").slideToggle("normal");
  });

});
</script>
 
<style type="text/css"> 

div.panel0,p.flip0
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip0
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel0
{
display:none;
}

div.panel1,p.flip1
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip1
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel1
{
display:none;
}

div.panel2,p.flip2
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip2
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel2
{
display:none;
}

div.panel3,p.flip3
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip3
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel3
{
display:none;
}

div.panel4,p.flip4
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip4
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel4
{
display:none;
}

div.panel5,p.flip5
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip5
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel5
{
display:none;
}

div.panel6,p.flip6
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip6
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel6
{
display:none;
}

div.panel7,p.flip7
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip7
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel7
{
display:none;
}

div.panel8,p.flip8
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip8
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel8
{
display:none;
}

div.panel9,p.flip9
{
    font-size: 0.9em;
    margin: 0;
    padding: 0.1em 0 0.1em 0.5em;
    border-bottom: 1px solid #86989B;
}
p.flip9
{
    color: white;
    font-weight: bold;
    background-color: #AFC1C4;
}
div.panel9
{
display:none;
}

</style>
<script type="text/javascript">

  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-18709417-2']);
  _gaq.push(['_trackPageview']);

  (function() {
    var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();

</script>


  </head>
  <body>
<div class="topbar">
  <a class="brand" title="Documentation Home" href="../index.html"><span id="logotext1">python</span><span id="logotext2">4</span><span id="logotext3">astronomers</span></a>
  <ul>
    <li><a class="homelink" title="Astropy Homepage" href="http://www.astropy.org"></a></li>
  </ul>
</div>

<div class="related">
    <h3>Navigation</h3>
    <ul>
      <li class="right">
	<a href="../vo/vo.html" title="Online Astronomy and the virtual observatory">
	  next &raquo;
	</a>
      </li>
      <li class="right">
	<a href="../astropy/coordinates.html" title="Celestial Coordinates">
	  &laquo; previous
	</a>
	 |
      </li>
      <li>
	<a href="../index.html">Python4Astronomers 2.0 documentation</a>
	 &raquo;
      </li>
      
      <li>Astropy II: Analyzing UVES Spectroscopy</li> 
    </ul>
</div>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="astropy-ii-analyzing-uves-spectroscopy">
<h1>Astropy II: Analyzing UVES Spectroscopy<a class="headerlink" href="#astropy-ii-analyzing-uves-spectroscopy" title="Permalink to this headline">¶</a></h1>
<p>This tutorial follows my real live data analysis of MN Lup and the code developed
below is taken (with only minor modifications) from the code that I used to
actually prepare the publication. The plots that will be developed below
appear in very similar form in the article published in ApJ (771, 70, 2013).</p>
<p>The examples below depend on each other and the plots in the last section make
use of things calculated in the earlier sections. Thus, if you need to restart
your python session in the course of this tutorial, please execute all the code
again.</p>
<p>Also, this tutorial works best if you follow along and execute the code shown
on your own computer. The page is already quite long and I do not include the
output you would see on your screen in this document.</p>
<div class="toctree-wrapper compound">
<ul class="simple">
</ul>
</div>
<div class="section" id="before-you-proceed">
<h2>Before you proceed<a class="headerlink" href="#before-you-proceed" title="Permalink to this headline">¶</a></h2>
<p>Please download this
<a class="reference download internal" href="../_downloads/astropy_UVES.tar.gz"><tt class="xref download docutils literal"><span class="pre">this</span> <span class="pre">tar</span> <span class="pre">file</span></tt></a> and extract
the content, either by clicking on the link or by executing this
python code:</p>
<div class="highlight-python"><div class="highlight"><pre>from astropy.extern.six.moves.urllib import request
import tarfile
url = &#39;http://python4astronomers.github.io/_downloads/astropy_UVES.tar.gz&#39;
tarfile.open(fileobj=request.urlopen(url), mode=&#39;r|*&#39;).extractall()
cd UVES
ls
</pre></div>
</div>
<p>Then start up IPython with the <tt class="docutils literal"><span class="pre">--matplotlib</span></tt> option and do the usual imports
to enable interactive plotting:</p>
<div class="highlight-python"><div class="highlight"><pre>$ ipython --matplotlib

import numpy as np
import matplotlib.pyplot as plt
</pre></div>
</div>
</div>
<div class="section" id="acknowledgments">
<h2>Acknowledgments<a class="headerlink" href="#acknowledgments" title="Permalink to this headline">¶</a></h2>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Moritz Guenther</td>
</tr>
<tr class="field-even field"><th class="field-name">Copyright:</th><td class="field-body">2013 Moritz Guenther</td>
</tr>
</tbody>
</table>
<p>Based on observations made with ESO Telescopes at the La Silla Paranal Observatory
under program ID 087.V0991(A).</p>
</div>
<div class="section" id="scientific-background">
<h2>Scientific background<a class="headerlink" href="#scientific-background" title="Permalink to this headline">¶</a></h2>
<p>In this tutorial we analyze data from MN Lup, a T Tauri star in the
Taurus-Auriga star forming region located at a distance of about 140 pc. MN Lup
has been observed simultaneously with XMM-Newton and the UVES spectrograph on the
VLT. MN Lup is suspected to be a classical T Tauri star, that is accreting mass
from a circumstellar disk. MN Lup has been Doppler imaged by <a class="reference external" href="http://adsabs.harvard.edu/abs/2005A%26A...440.1105S">Strassmeier et al.
(2005, A&amp;A, 440, 1105)</a>
with a very similar UVES setup and those authors claim an rotationally modulated
accretion spot.</p>
<p>In the X-ray data we find moderate indications for accretion. In this
tutorial we analyze (some of) the UVES data to search for rotationally modulated
features in the emission line profiles, which could be due to an accretion spot
on the stellar surface.</p>
</div>
<div class="section" id="reading-the-data">
<h2>Reading the data<a class="headerlink" href="#reading-the-data" title="Permalink to this headline">¶</a></h2>
<p>The previous astropy tutorial already covered
<a class="reference internal" href="../astropy/fits.html#handling-fits-files"><em>Handling FITS files</em></a> and <a class="reference internal" href="../astropy/wcs.html#wcs-transformations"><em>WCS Transformations</em></a>, so the explanation here
is only very brief. Check the <a class="reference external" href="http://docs.astropy.org">astropy documentation</a>
or the other two tutorials for more details:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">glob</span> <span class="kn">import</span> <span class="n">glob</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">astropy.wcs</span> <span class="kn">import</span> <span class="n">WCS</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span>

<span class="c"># glob searches through directories similar to the Unix shell</span>
<span class="n">filelist</span> <span class="o">=</span> <span class="n">glob</span><span class="p">(</span><span class="s">&#39;*.fits&#39;</span><span class="p">)</span>
<span class="c"># sort alphabetically - given the way the filenames are</span>
<span class="c"># this also sorts in time</span>
<span class="n">filelist</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
</pre></div>
</div>
<p>Read the first fits file in the list and check what is in there:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">sp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filelist</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="n">sp</span><span class="o">.</span><span class="n">info</span><span class="p">()</span>
</pre></div>
</div>
<p>We see that the data is given as the primary image and all other info is
part of the primary header. So, we can extract the WCS from that header
to get the wavelength coordinate:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">header</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

<span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
<span class="c">#make index array</span>
<span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS1&#39;</span><span class="p">])</span>

<span class="n">wavelength</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">index</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
<span class="n">wavelength</span><span class="o">.</span><span class="n">shape</span>
<span class="c">#Ahh, this has the wrong dimension. So we flatten it.</span>
<span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
</pre></div>
</div>
<p>The flux is contained in the primary image:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flux</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>
</pre></div>
</div>
</div>
<div class="section" id="making-code-reusable-as-a-function">
<h2>Making code reusable as a function<a class="headerlink" href="#making-code-reusable-as-a-function" title="Permalink to this headline">¶</a></h2>
<p>Now, we do not want to repeat this process for every single file by hand,
so let us define a function that takes the filename as input and returns
the wavelength and flux arrays and the time of the observation.
In python, functions are created with the <tt class="docutils literal"><span class="pre">def</span></tt> statements.
All lines that have an indentation level below the <cite>def</cite> statement are part
of the function. Functions can (but do not have to) return values using
the <tt class="docutils literal"><span class="pre">return</span></tt> statement.</p>
<p>If a function <tt class="docutils literal"><span class="pre">func</span></tt> is contained in a file called <tt class="docutils literal"><span class="pre">spectra_utils.py</span></tt> in
the current directory, then this file can be imported into a python session in
order to use the function <cite>func</cite> with the following command:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">spectra_utils</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">spectra_utils</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>Alternatively, you can import just one (or a few) of many different functions
that are defined in your file <tt class="docutils literal"><span class="pre">spectra_utils.py</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">spectra_utils</span> <span class="kn">import</span> <span class="n">func</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>You will recognize that python does not make a difference between modules that come
with python (e.g. <cite>glob</cite>), external modules (e.g. <cite>numpy</cite> or <cite>astropy</cite>) and modules
that you write yourself. The syntax to import those modules or functions
is the same in all cases, provided that the directory where your module is
defined is in the search path (<a class="reference external" href="http://docs.python.org/2/tutorial/modules.html">more about python modules and the search path</a>).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p>You can also define a function on the interactive interpreter by just
typing it line by line. However,
if you work in an interactive session, then the function ends as soon as there
is a blank line. This makes it a little inconvenient to copy and paste more
than the simplest functions into an interpreter.
Fortunately, ipython offers two magic functions that take care of this:</p>
<ol class="arabic simple">
<li>You can mark code in some editor, copy it to the clipboard and then
type <tt class="docutils literal"><span class="pre">%paste</span></tt> in ipython.</li>
<li>You type <tt class="docutils literal"><span class="pre">%cpaste</span></tt> in ipython you can paste code (e.g. with the
mouse) and ipython will correct the leading number of white spaces and
ignore empty lines.</li>
</ol>
<p class="last">These two tricks can be used with any type of code, but are particularly useful
to define functions.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Once you used <tt class="docutils literal"><span class="pre">import</span> <span class="pre">spectra_utils</span></tt> python will not monitor the source file.
If you change the source code of <tt class="docutils literal"><span class="pre">func</span></tt> in the file, you need to
<tt class="docutils literal"><span class="pre">reload(spectra_utils)</span></tt> to load the new version of <tt class="docutils literal"><span class="pre">func</span></tt>.</p>
</div>
<p>So, after all this discussion, we can now define a function that automates the
loading of a single spectrum using the commands we developed above. Even if
this function is fairly short, we still add some documentation to the header,
so that we can look up what parameters it needs when we come back to this
project a while later. Personally, I comment every function that is longer
than two lines:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">read_spec</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Read a UVES spectrum from the ESO pipeline</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : string</span>
<span class="sd">       name of the fits file with the data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    wavelength : np.ndarray</span>
<span class="sd">        wavelength (in Ang)</span>
<span class="sd">    flux : np.ndarray</span>
<span class="sd">        flux (in erg/s/cm**2)</span>
<span class="sd">    date_obs : string</span>
<span class="sd">        time of observation</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="n">wcs</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">header</span><span class="p">)</span>
    <span class="c">#make index array</span>
    <span class="n">index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;NAXIS1&#39;</span><span class="p">])</span>

    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wcs</span><span class="o">.</span><span class="n">wcs_pix2world</span><span class="p">(</span><span class="n">index</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">flux</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

    <span class="n">date_obs</span> <span class="o">=</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;Date-OBS&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">date_obs</span>
</pre></div>
</div>
<div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p class="last">Try to find out how you can read the help for this function from the
command line.</p>
</div>
<p class="flip1">Click to Show/Hide Solution</p> <div class="panel1"><div class="highlight-python"><div class="highlight"><pre>help(read_spec)
#or
read_spec?
</pre></div>
</div>
</div><div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p class="last">The dataset of UVES spectra should have been taken using all the same setup.
Write a function that returns the exposure time (<tt class="docutils literal"><span class="pre">EXPTIME</span></tt>),
the wavelength zero point
(<tt class="docutils literal"><span class="pre">CRVAL1</span></tt>), and the arm used (UVES has a red and a blue arm - see keyword
<tt class="docutils literal"><span class="pre">HIERARCH</span> <span class="pre">ESO</span> <span class="pre">INS</span> <span class="pre">PATH</span></tt>). Then check that all exposures have the same
setup.</p>
</div>
<p class="flip2">Click to Show/Hide Solution</p> <div class="panel2"><div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">read_setup</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;Get setup for UVES spectrum from the ESO pipeline</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    filename : string</span>
<span class="sd">       name of the fits file with the data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    exposure_time : float</span>
<span class="sd">    wavelength_zero_point : float</span>
<span class="sd">    optical_arm : string</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="n">sp</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="n">header</span> <span class="o">=</span> <span class="n">sp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>

    <span class="k">return</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;EXPTIME&#39;</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;CRVAL1&#39;</span><span class="p">],</span> <span class="n">header</span><span class="p">[</span><span class="s">&#39;HIERARCH ESO INS PATH&#39;</span><span class="p">]</span>

<span class="c"># Let&#39;s just print the setup on the screen</span>
<span class="c"># We&#39;ll see if it&#39;s all the same.</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filelist</span><span class="p">:</span>
    <span class="k">print</span><span class="p">(</span><span class="n">read_setup</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
</pre></div>
</div>
</div><p>The UVES pipeline that was used to reduce the data that we use in the this example
employs a fixed wavelength grid (see exercise above),
thus the <tt class="docutils literal"><span class="pre">wavelength</span></tt> is the same for all spectra.
This makes it easy to define an array that can hold the fluxes of all
observations. Then, we loop over the list of all filenames and fill this array
with data:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">wavelength</span><span class="p">)))</span>
<span class="c"># date comes as string with 23 characters (dtype = &#39;S23&#39;)</span>
<span class="n">date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">filelist</span><span class="p">)),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="s">&#39;S23&#39;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fname</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filelist</span><span class="p">):</span>
    <span class="n">w</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">date_obs</span> <span class="o">=</span> <span class="n">read_spec</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">f</span>
    <span class="n">date</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">date_obs</span>
</pre></div>
</div>
</div>
<div class="section" id="units-and-constants-in-astropy">
<h2>Units and constants in astropy<a class="headerlink" href="#units-and-constants-in-astropy" title="Permalink to this headline">¶</a></h2>
<p>Often, one has to keep track of the units for certain values. Was the wavelength
given in Angstrom or in nm? In X-ray observations, a common unit of wavelength is
keV. How many nm is 0.65 keV?
<a class="reference external" href="http://astropy.readthedocs.org/en/stable/units/index.html">astropy.units</a>
offers a framework that can take
care of this book-keeping and propagate the units through many (but not all)
mathematical operations (e.g. addition, division, multiplication).
Furthermore,
<a class="reference external" href="http://astropy.readthedocs.org/en/stable/constants/index.html">astropy.constants</a>  supplies the values of
many physical and astronomical constants.
The easiest way to attach a unit to a number is by multiplication:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">astropy.units</span> <span class="kn">as</span> <span class="nn">u</span>
<span class="kn">from</span> <span class="nn">astropy.constants.si</span> <span class="kn">import</span> <span class="n">c</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">M_sun</span><span class="p">,</span> <span class="n">R_sun</span>

<span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span>

<span class="c"># Let&#39;s define some constants we need for the exercises further down</span>
<span class="c"># Again, we multiply the value with a unit here</span>
<span class="n">heliocentric</span> <span class="o">=</span> <span class="o">-</span><span class="mf">23.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
<span class="n">v_rad</span> <span class="o">=</span> <span class="o">-</span><span class="mf">4.77</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>  <span class="c"># Strassmeier et al. (2005)</span>
<span class="n">R_MN_Lup</span> <span class="o">=</span> <span class="mf">0.9</span> <span class="o">*</span> <span class="n">R_sun</span>      <span class="c"># Strassmeier et al. (2005)</span>
<span class="n">M_MN_Lup</span> <span class="o">=</span> <span class="mf">0.6</span> <span class="o">*</span> <span class="n">M_sun</span>      <span class="c"># Strassmeier et al. (2005)</span>
<span class="n">vsini</span> <span class="o">=</span> <span class="mf">74.6</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">s</span>   <span class="c"># Strassmeier et al. (2005)</span>
<span class="n">period</span> <span class="o">=</span> <span class="mf">0.439</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span>      <span class="c"># Strassmeier et al. (2005)</span>

<span class="n">inclination</span> <span class="o">=</span> <span class="mf">45.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">degree</span> <span class="c"># Strassmeier et al. (2005)</span>
<span class="c"># All numpy trigonometric functions expect the input in radian.</span>
<span class="c"># So far, astropy does not know this, so we need to convert the</span>
<span class="c"># angle manually</span>
<span class="n">incl</span> <span class="o">=</span> <span class="n">inclination</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">radian</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we can use those variables in our calculations. MN Lup is a T Tauri
star (TTS), which is possibly surrounded by an accretion disk. In the spectra
we will be looking for signatures of accretion. We expect those accretion
signatures to appear close to the free-fall velocity v that a mass m reaches, when
it hits the stellar surface. We can calculate the infall speed using simple
energy conservation:</p>
<div class="math" id="formula-vaccr">
<p><span class="math">E_{kin}  =  E_{grav}

\frac{1}{2} m v^2  =  G \frac{m M_*}{R_*}</span></p>
</div><p>So, let us calculate the free-fall velocity for MN Lup:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">v_accr</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span> <span class="n">G</span> <span class="o">*</span> <span class="n">M_MN_Lup</span><span class="o">/</span><span class="n">R_MN_Lup</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">v_accr</span>
<span class="go">504469.027564 m / (s)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># Maybe astronomers prefer it in the traditional cgs system?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">v_accr</span><span class="o">.</span><span class="n">cgs</span>
<span class="go">50446902.7564 cm / (s)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c"># Or in some really obscure unit?</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">v_accr</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">mile</span> <span class="o">/</span> <span class="n">u</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
<span class="go">1128465.07598 mi / (h)</span>
</pre></div>
</div>
<p>How does the accretion velocity relate to the rotational velocity?</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v_rot</span> <span class="o">=</span> <span class="n">vsini</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">incl</span><span class="p">)</span>
<span class="n">v_accr</span> <span class="o">/</span> <span class="n">v_rot</span>
</pre></div>
</div>
<p>Oh, what is that? The seconds are gone, but <tt class="docutils literal"><span class="pre">astropy.quantity</span></tt> objects keep
their different length units unless told otherwise:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="p">(</span><span class="n">v_accr</span> <span class="o">/</span> <span class="n">v_rot</span><span class="p">)</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
</pre></div>
</div>
<p>The reason for this is that it is not uncommon to use different length units in
a single constant, e.g. the Hubble constant is commonly given in &#8220;km/ (s * Mpc)&#8221;.
&#8220;km&#8221; and &#8220;Mpc&#8221; are both units of length, but generally you do <em>not</em> want to
shorten this to &#8220;1/s&#8221;.</p>
<p>We can now use the <tt class="docutils literal"><span class="pre">astropy.units</span></tt> mechanism to correct the wavelength
scale to the heliocentric velocity scale:</p>
<div class="math">
<p><span class="math">\lambda_{heliocentric} = \lambda_{bariocentric} * (1 + \frac{v_{helio}}{c})</span></p>
</div><p>Naively, we could try:</p>
<div class="highlight-python"><div class="highlight"><pre>wavelength = wavelength * (1. + heliocentric/c)
TypeError: unsupported operand type(s) for +: &#39;float&#39; and &#39;Quantity&#39;
</pre></div>
</div>
<p>However, this fails, because <tt class="docutils literal"><span class="pre">heliocentric/c</span></tt> is in units of &#8220;km/m&#8221; and <tt class="docutils literal"><span class="pre">1.</span></tt>
is just a number. From the notation above, it is not clear what we actually want.
Do we ask for the value of <tt class="docutils literal"><span class="pre">heliocentric/c</span> <span class="pre">+</span> <span class="pre">1.</span></tt> or do we want to simplify the
units of  <tt class="docutils literal"><span class="pre">heliocentric/c</span></tt> and after that add <tt class="docutils literal"><span class="pre">1.</span></tt>?
There are several ways to make the instruction precise,
but one is to explicitly add <tt class="docutils literal"><span class="pre">u.dimensionless_unscaled</span></tt> to <tt class="docutils literal"><span class="pre">1.</span></tt>
to tell astropy that this number is dimensionless and does not carry any scaling:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wavelength</span> <span class="o">=</span> <span class="n">wavelength</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span><span class="o">+</span> <span class="n">heliocentric</span><span class="o">/</span><span class="n">c</span><span class="p">)</span>
</pre></div>
</div>
<p>I want to mention one more feature here (check out
<a class="reference external" href="http://astropy.readthedocs.org/en/stable/units/index.html">astropy.units</a> for
more): The ability to convert the spectral axis to frequencies or energies.
Normally, a unit of length is not equivalent to a unit of energy or to a
frequency, but this conversion makes sense for the wavelength of a spectrum.
This is how it can be done:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">wavelength</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">keV</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
<span class="n">wavelength</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">Hz</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">u</span><span class="o">.</span><span class="n">spectral</span><span class="p">())</span>
</pre></div>
</div>
<div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p>Spectroscopically, MN Lup is classified as spectral type M0 V, thus
the gravitational acceleration on the surface <span class="math">\log(g)</span>
should be comparable to the sun.
(For non-stellar astronomers: Conventionally, all values are given
in the cgs system. The value for the sun is <span class="math">\log(g) = 4.4</span>.)</p>
<p class="last">Calculate <span class="math">\log(g)</span> for MN Lup with the values for the mass
and radius given above. Those values were determined from
evolutionary tracks. Check if the <span class="math">\log(g)</span> is consistent
with the value expected from spectroscopy.</p>
</div>
<p class="flip7">Click to Show/Hide Solution</p> <div class="panel7"><p>The values from evolutionary tracks are indeed consistent with the
spectroscopically estimated surface gravity:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="k">print</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">((</span><span class="n">G</span><span class="o">*</span><span class="n">M_MN_Lup</span><span class="o">/</span><span class="n">R_MN_Lup</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">cgs</span><span class="p">)</span>
<span class="go">4.3080943799180433</span>
</pre></div>
</div>
</div><div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p>Write a function that turns a wavelength scale into a velocity scale.
We want to input a wavelengths array and the rest wavelength of a spectral
line. We need this function later to show the red- and blueshift of the
spectrum relative to the the Ca II H line. Use the following definition
to make sure the that code below can use it later:</p>
<div class="highlight-python"><div class="highlight"><pre>def wave2doppler(wavelength_array, wavelength_line):
    .. do something ..
    return array_of_dopplershifts
</pre></div>
</div>
<p>You can test if you function works by calculating the a Dopplershift
of the following wavelengths relative to <span class="math">H_\alpha</span>:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">waveclosetoHa</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6562.</span><span class="p">,</span><span class="mi">6563</span><span class="p">,</span><span class="mf">6565.</span><span class="p">])</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span>
<span class="k">print</span><span class="p">(</span><span class="n">wave2doppler</span><span class="p">(</span><span class="n">waveclosetoHa</span><span class="p">,</span> <span class="mf">656.489</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">))</span>
</pre></div>
</div>
<p class="last">I get -132, -86 and +5 km/s.</p>
</div>
<p class="flip3">Click to Show/Hide Solution</p> <div class="panel3"><div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">wave2doppler</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w0</span><span class="p">):</span>
    <span class="n">doppler</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span><span class="o">-</span><span class="n">w0</span><span class="p">)</span><span class="o">/</span><span class="n">w0</span> <span class="o">*</span> <span class="n">c</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">doppler</span>

<span class="k">print</span><span class="p">(</span><span class="n">wave2doppler</span><span class="p">(</span><span class="n">waveclosetoHa</span><span class="p">,</span> <span class="mf">656.489</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span><span class="p">))</span>
</pre></div>
</div>
</div><div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p>Write a function that takes a wavelength array and the rest wavelength of
a spectral line as input, turns it into a Doppler shift (you can use
the function from the last exercise),
subtracts the radial velocity of MN Lup (4.77 km/s) and expresses
the resulting velocity in units of vsini.
We need this function later to show the red- and blueshift of the
spectrum relative to the Ca II H line. Use the following definition
to make sure the that code below can use it later:</p>
<div class="last highlight-python"><div class="highlight"><pre>def w2vsini(wavelength_array, wavelength_line):
    .. do something ..
    return array_of_shifts_in_vsini
</pre></div>
</div>
</div>
<p class="flip4">Click to Show/Hide Solution</p> <div class="panel4"><div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">w2vsini</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w0</span><span class="p">):</span>
    <span class="n">v</span> <span class="o">=</span> <span class="n">wave2doppler</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">w0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">4.77</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">km</span><span class="o">/</span><span class="n">u</span><span class="o">.</span><span class="n">s</span>
    <span class="k">return</span> <span class="n">v</span> <span class="o">/</span> <span class="n">vsini</span>
</pre></div>
</div>
</div></div>
<div class="section" id="converting-times">
<h2>Converting times<a class="headerlink" href="#converting-times" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://astropy.readthedocs.org/en/stable/time/index.html">astropy.time</a>
provides methods to convert times and dates between different
systems and formats. Since the ESO fits headers already contain the time of the
observation in different systems, we could just read the keyword in the time
system we like, but we will use <tt class="docutils literal"><span class="pre">astropy.time</span></tt> to make this conversion here.
<tt class="docutils literal"><span class="pre">astropy.time.Time</span></tt> will parse many common input formats (strings, floats), but
unless the format is unambiguous the format needs to be specified (e.g. a number
could mean JD or MJD or year). Also, the time system needs to be given (e.g. UTC).
Below are several examples, initialized from different header keywords:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">astropy.time</span> <span class="kn">import</span> <span class="n">Time</span>
<span class="n">t1</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;MJD-Obs&#39;</span><span class="p">],</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;mjd&#39;</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s">&#39;utc&#39;</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">header</span><span class="p">[</span><span class="s">&#39;Date-Obs&#39;</span><span class="p">],</span> <span class="n">scale</span> <span class="o">=</span> <span class="s">&#39;utc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Times can be expressed in different formats:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span>
<span class="go">&lt;Time object: scale=&#39;utc&#39; format=&#39;mjd&#39; vals=55784.9749105&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">isot</span>
<span class="go">&#39;2011-08-11T23:23:52.266&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">t2</span>
<span class="go">&lt;Time object: scale=&#39;utc&#39; format=&#39;isot&#39; vals=2011-08-11T23:23:52.266&gt;</span>
</pre></div>
</div>
<p>or be converted to a different time system:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="gp">&gt;&gt;&gt; </span><span class="n">t1</span><span class="o">.</span><span class="n">tt</span>
<span class="go">&lt;Time object: scale=&#39;tt&#39; format=&#39;mjd&#39; vals=55784.9756765&gt;</span>
</pre></div>
</div>
<p>Times can also be initialized from arrays and we can calculate time differences:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">obs_times</span> <span class="o">=</span> <span class="n">Time</span><span class="p">(</span><span class="n">date</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="s">&#39;utc&#39;</span><span class="p">)</span>
<span class="n">delta_t</span> <span class="o">=</span> <span class="n">obs_times</span> <span class="o">-</span> <span class="n">Time</span><span class="p">(</span><span class="n">date</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">scale</span> <span class="o">=</span> <span class="s">&#39;utc&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we want to express the time difference between the individual spectra of
MN Lup in rotational periods. While the unit of <tt class="docutils literal"><span class="pre">delta_t</span></tt> is days, unfortunately
<tt class="docutils literal"><span class="pre">astropy.time.Time</span></tt> and <tt class="docutils literal"><span class="pre">astropy.units.Quantity</span></tt> objects do not work together
yet, so we will have to convert from one to the other explicitly:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">delta_p</span> <span class="o">=</span> <span class="n">delta_t</span><span class="o">.</span><span class="n">val</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">day</span> <span class="o">/</span> <span class="n">period</span>
</pre></div>
</div>
</div>
<div class="section" id="normalize-the-flux-to-the-local-continuum">
<h2>Normalize the flux to the local continuum<a class="headerlink" href="#normalize-the-flux-to-the-local-continuum" title="Permalink to this headline">¶</a></h2>
<p>In this example we want to look at the time evolution of a single specific
emission line in the spectrum. In order to estimate the equivalent width
or make reasonable plots we need to normalize the flux to the local continuum.
In this specific case the emission line is bright and the continuum can be
described reasonably by a second-order polynomial.</p>
<a class="reference internal image-reference" href="../_images/CaII.png"><img alt="../_images/CaII.png" class="align-center" src="../_images/CaII.png" style="width: 400.0px; height: 300.0px;" /></a>
<p>So, we define two regions left and right of the emission line, where we fit the
polynomial. Looking at the figure, <tt class="docutils literal"><span class="pre">[3925*u.AA,</span> <span class="pre">3930*u.AA]</span></tt> and
<tt class="docutils literal"><span class="pre">[3938*u.AA,</span> <span class="pre">3945*u.AA]</span></tt> seem right for that. Then, we normalize the flux by
this polynomial.</p>
<p>The following function will do that:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="k">def</span> <span class="nf">region_around_line</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">cont</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;cut out and normalize flux around a line</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    w : 1 dim np.ndarray</span>
<span class="sd">        array of wavelengths</span>
<span class="sd">    flux : np.ndarray of shape (N, len(w))</span>
<span class="sd">        array of flux values for different spectra in the series</span>
<span class="sd">    cont : list of lists</span>
<span class="sd">        wavelengths for continuum normalization [[low1,up1],[low2, up2]]</span>
<span class="sd">        that described two areas on both sides of the line</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="c">#index is true in the region where we fit the polynomial</span>
    <span class="n">indcont</span> <span class="o">=</span> <span class="p">((</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span> <span class="o">|</span><span class="p">((</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
    <span class="c">#index of the region we want to return</span>
    <span class="n">indrange</span> <span class="o">=</span> <span class="p">(</span><span class="n">w</span> <span class="o">&gt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">w</span> <span class="o">&lt;</span> <span class="n">cont</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
    <span class="c"># make a flux array of shape</span>
    <span class="c"># (number of spectra, number of points in indrange)</span>
    <span class="n">f</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">indrange</span><span class="o">.</span><span class="n">sum</span><span class="p">()))</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">flux</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="c"># fit polynomial of second order to the continuum region</span>
        <span class="n">linecoeff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">w</span><span class="p">[</span><span class="n">indcont</span><span class="p">],</span> <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">indcont</span><span class="p">],</span><span class="mi">2</span><span class="p">)</span>
        <span class="c"># divide the flux by the polynomial and put the result in our</span>
        <span class="c"># new flux array</span>
        <span class="n">f</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">flux</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">indrange</span><span class="p">]</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">polyval</span><span class="p">(</span><span class="n">linecoeff</span><span class="p">,</span> <span class="n">w</span><span class="p">[</span><span class="n">indrange</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">w</span><span class="p">[</span><span class="n">indrange</span><span class="p">],</span> <span class="n">f</span>

<span class="n">wcaII</span><span class="p">,</span> <span class="n">fcaII</span> <span class="o">=</span> <span class="n">region_around_line</span><span class="p">(</span><span class="n">wavelength</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
               <span class="p">[[</span><span class="mi">3925</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> <span class="mi">3930</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">],[</span><span class="mi">3938</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">,</span> <span class="mi">3945</span><span class="o">*</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">]])</span>
</pre></div>
</div>
</div>
<div class="section" id="publication-ready-output">
<h2>Publication ready output<a class="headerlink" href="#publication-ready-output" title="Permalink to this headline">¶</a></h2>
<div class="section" id="tables">
<h3>Tables<a class="headerlink" href="#tables" title="Permalink to this headline">¶</a></h3>
<p>We will calculate the equivalent width in Angstroms of the emission line
for the first spectrum:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ew</span> <span class="o">=</span> <span class="n">fcaII</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="mf">1.</span>
<span class="n">ew</span> <span class="o">=</span> <span class="n">ew</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wcaII</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">ew</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
</pre></div>
</div>
<p>Using <tt class="docutils literal"><span class="pre">numpy</span></tt> array notation we can actually process all spectra at once:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">delta_lam</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">wcaII</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="n">ew</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">fcaII</span> <span class="o">-</span> <span class="mf">1.</span><span class="p">)[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">delta_lam</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,</span> <span class="p">:],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Now, we want to generate a LaTeX table of the observation times, period
and equivalent width that we can directly paste into our manuscript. To do so,
we first collect all the columns and make an <tt class="docutils literal"><span class="pre">astropy.table.Table</span></tt> object. (Please
check <a class="reference external" href="http://astropy.readthedocs.org/en/stable/table/index.html">astropy.table</a>
or <a class="reference internal" href="../astropy/tables.html#tabular-data"><em>Tabular data</em></a> for more
details on <tt class="docutils literal"><span class="pre">Table</span></tt>). So, here is the code:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Table</span>
<span class="kn">import</span> <span class="nn">astropy.io.ascii</span> <span class="kn">as</span> <span class="nn">ascii</span>

<span class="n">datecol</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;Obs Date&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">date</span><span class="p">)</span>
<span class="n">pcol</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;phase&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">delta_p</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;{:.1f}&#39;</span><span class="p">)</span>
<span class="n">ewcol</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">name</span> <span class="o">=</span> <span class="s">&#39;EW&#39;</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="n">ew</span><span class="p">,</span> <span class="n">format</span> <span class="o">=</span> <span class="s">&#39;{:.1f}&#39;</span><span class="p">,</span> <span class="n">units</span> <span class="o">=</span> <span class="s">&#39;</span><span class="se">\\</span><span class="s">AA&#39;</span><span class="p">)</span>
<span class="n">tab</span> <span class="o">=</span> <span class="n">Table</span><span class="p">((</span><span class="n">datecol</span><span class="p">,</span> <span class="n">pcol</span><span class="p">,</span> <span class="n">ewcol</span><span class="p">))</span>
<span class="c"># latexdicts[&#39;AA&#39;] contains the style specifics for A&amp;A (\hline etc.)</span>
<span class="n">tab</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&#39;EWtab.tex&#39;</span><span class="p">,</span> <span class="n">latexdict</span> <span class="o">=</span> <span class="n">ascii</span><span class="o">.</span><span class="n">latexdicts</span><span class="p">[</span><span class="s">&#39;AA&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="plots">
<h3>Plots<a class="headerlink" href="#plots" title="Permalink to this headline">¶</a></h3>
<p>We will make two plots. The plotting is done with
<a class="reference external" href="http://matplotlib.org">matplotlib</a>, and does not involve Astropy itself.
Plotting is introduced in <a class="reference internal" href="../plotting/plotting.html#plotting-and-images"><em>Plotting and Images</em></a> and more details on
plotting can be found there. When in doubt, use the search engine of your choice
and ask the Internet. Here, I mainly want to illustrate that Astropy can be
used in real-live data analysis.
Thus, I do not explain every step in the plotting in detail.
The plots we produce below appear in very
similar form in Guenther et al. 2013 (ApJ, 771, 70).</p>
<p>In both cases we want the x-axis to show the Doppler shift expressed in units
of the rotational velocity. In this way, features that are rotationally
modulated will stick out between -1 and +1:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">x</span> <span class="o">=</span> <span class="n">w2vsini</span><span class="p">(</span><span class="n">wcaII</span><span class="p">,</span> <span class="mf">393.366</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">nm</span><span class="p">)</span><span class="o">.</span><span class="n">decompose</span><span class="p">()</span>
</pre></div>
</div>
<p>First, we will show the line profile:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="c"># set reasonable figsize for 1-column figures</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fcaII</span><span class="p">[</span><span class="mi">0</span><span class="p">,:])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mi">3</span><span class="p">,</span><span class="o">+</span><span class="mi">3</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;line shift [v sin(i)]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Ca II H line in MN Lup&#39;</span><span class="p">)</span>
<span class="c"># when using this interface, we need to explicitly call the draw routine</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/CaII-lines-one.png"><img alt="../_images/CaII-lines-one.png" class="align-center" src="../_images/CaII-lines-one.png" style="width: 400.0px; height: 300.0px;" /></a>
<div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p class="last">The plot above shows only a single spectrum. Plot all spectra into a single
plot and introduce a sensible offset between them, so that we can follow
the time evolution of the line.</p>
</div>
<p class="flip5">Click to Show/Hide Solution</p> <div class="panel5"><p>There are clearly several ways to produce a well looking plot. Here is one
way:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">yshift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">((</span><span class="n">fcaII</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="o">*</span> <span class="mf">0.5</span>
<span class="c">#shift the second night up by a little more</span>
<span class="n">yshift</span><span class="p">[:]</span> <span class="o">+=</span> <span class="mf">1.5</span>
<span class="n">yshift</span><span class="p">[</span><span class="mi">13</span><span class="p">:]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">25</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">fcaII</span><span class="p">[</span><span class="n">i</span><span class="p">,:]</span><span class="o">+</span><span class="n">yshift</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="s">&#39;k&#39;</span><span class="p">)</span>

<span class="c">#separately show the mean line profile in a different color</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcaII</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="s">&#39;b&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">2.5</span><span class="p">,</span><span class="o">+</span><span class="mf">2.5</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;line shift [$v </span><span class="se">\\</span><span class="s">sin i$]&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;flux&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s">&#39;Ca II H line in MN Lup&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/CaII-lines-all.png"><img alt="../_images/CaII-lines-all.png" class="align-center" src="../_images/CaII-lines-all.png" style="width: 400.0px; height: 300.0px;" /></a>
</div><p>Next, we will make a more advanced plot. For each spectrum we calculate
the difference to the mean flux:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fmean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">fcaII</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">fdiff</span> <span class="o">=</span> <span class="n">fcaII</span> <span class="o">-</span> <span class="n">fmean</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">,:]</span>
</pre></div>
</div>
<p>In the following simple plot, we can already see features moving through the line.
However, the axis scales are not right, the gap between both nights is not visible
and there is no proper labeling:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fdiff</span><span class="p">,</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/CaII-1.png"><img alt="../_images/CaII-1.png" class="align-center" src="../_images/CaII-1.png" style="width: 400.0px; height: 300.0px;" /></a>
<p>In the following, we will plot the spectra from both nights separately.
Also, we will pass the <tt class="docutils literal"><span class="pre">extent</span></tt> keyword to <tt class="docutils literal"><span class="pre">ax.imshow</span></tt> which takes care
of the axis:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">ind1</span> <span class="o">=</span> <span class="n">delta_p</span> <span class="o">&lt;</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>
<span class="n">ind2</span> <span class="o">=</span> <span class="n">delta_p</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">dimensionless_unscaled</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">]:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fdiff</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span> <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">delta_p</span><span class="p">[</span><span class="n">ind</span><span class="p">]),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_p</span><span class="p">[</span><span class="n">ind</span><span class="p">])),</span> <span class="n">aspect</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">delta_p</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">delta_p</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">1.9</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/CaII-2.png"><img alt="../_images/CaII-2.png" class="align-center" src="../_images/CaII-2.png" style="width: 400.0px; height: 300.0px;" /></a>
<p>Now, this plot is already much better, but there are still some things that can be
improved:</p>
<ul>
<li><p class="first">Introduce an offset on the y-axis to reduce the amount of white space.</p>
</li>
<li><dl class="first docutils">
<dt>Strictly speaking, the image shown is not quite the right scale because the</dt>
<dd><p class="first last"><tt class="docutils literal"><span class="pre">extent</span></tt> keyword gives the edges of the image shown, while <tt class="docutils literal"><span class="pre">x</span></tt> and
<tt class="docutils literal"><span class="pre">delta_p</span></tt> contain the bin mid-points.</p>
</dd>
</dl>
</li>
<li><p class="first">Use a gray scale instead of color to save publication charges.</p>
</li>
<li><p class="first">Add labels to the axis.</p>
</li>
</ul>
<p>The following code addresses these points:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="c"># shift a little for plotting purposes</span>
<span class="n">pplot</span> <span class="o">=</span> <span class="n">delta_p</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">value</span>
<span class="n">pplot</span><span class="p">[</span><span class="n">ind2</span><span class="p">]</span> <span class="o">-=</span> <span class="mf">1.5</span>
<span class="c"># image goes from x1 to x2, but really x1 should be middle of first pixel</span>
<span class="n">delta_t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">delta_p</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
<span class="n">delta_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">x</span><span class="p">))</span><span class="o">/</span><span class="mf">2.</span>
<span class="c"># imshow does the normalization for plotting really well, but here I do it</span>
<span class="c"># by hand to ensure it goes -1,+1 (that makes color bar look good)</span>
<span class="n">fdiff</span> <span class="o">=</span> <span class="n">fdiff</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">fdiff</span><span class="p">))</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">ind</span> <span class="ow">in</span> <span class="p">[</span><span class="n">ind1</span><span class="p">,</span> <span class="n">ind2</span><span class="p">]:</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">fdiff</span><span class="p">[</span><span class="n">ind</span><span class="p">,:],</span>
         <span class="n">extent</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">-</span><span class="n">delta_x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">+</span><span class="n">delta_x</span><span class="p">,</span>
                   <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pplot</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pplot</span><span class="p">[</span><span class="n">ind</span><span class="p">])</span><span class="o">+</span><span class="n">delta_t</span><span class="p">),</span>
         <span class="n">aspect</span> <span class="o">=</span> <span class="s">&quot;auto&quot;</span><span class="p">,</span> <span class="n">origin</span> <span class="o">=</span> <span class="s">&#39;lower&#39;</span><span class="p">,</span> <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">Greys_r</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pplot</span><span class="p">)</span><span class="o">-</span><span class="n">delta_t</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pplot</span><span class="p">)</span><span class="o">+</span><span class="n">delta_t</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.9</span><span class="p">,</span><span class="mf">1.9</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s">&#39;vel in $v</span><span class="se">\\</span><span class="s">sin i$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">plt</span><span class="o">.</span><span class="n">MaxNLocator</span><span class="p">(</span><span class="mi">4</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">pplot</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pos</span><span class="p">):</span>
    <span class="s">&#39;The two args are the value and tick position&#39;</span>
    <span class="s">&#39;Function to make tick labels look good.&#39;</span>
    <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mf">0.5</span><span class="p">:</span>
        <span class="n">yreal</span> <span class="o">=</span> <span class="n">y</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">yreal</span> <span class="o">=</span> <span class="n">y</span> <span class="o">+</span> <span class="mf">1.5</span>
    <span class="k">return</span> <span class="n">yreal</span>

<span class="n">formatter</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="n">pplot</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">formatter</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s">&#39;period&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.15</span><span class="p">,</span> <span class="n">right</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">,</span> <span class="n">top</span> <span class="o">=</span> <span class="mf">0.99</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">draw</span><span class="p">()</span>
</pre></div>
</div>
<a class="reference internal image-reference" href="../_images/CaII-3.png"><img alt="../_images/CaII-3.png" class="align-center" src="../_images/CaII-3.png" style="width: 400.0px; height: 300.0px;" /></a>
<div class="admonition-exercise admonition">
<p class="first admonition-title">Exercise</p>
<p class="last">Understand the code for the last plot. Some of the commands used are
already pretty advanced stuff. Remember, any Internet search engine can be
your friend.</p>
</div>
<p class="flip6">Click to Show/Hide Solution</p> <div class="panel6"><p>Clearly, I did not develop this code for scratch.
The <a class="reference external" href="http://matplotlib.org/gallery.html">matplotlib gallery</a> is my
preferred place to look for plotting solutions.</p>
</div></div>
</div>
<div class="section" id="contributing-to-astropy">
<h2>Contributing to Astropy<a class="headerlink" href="#contributing-to-astropy" title="Permalink to this headline">¶</a></h2>
<p><a class="reference external" href="http://astropy.org">Astropy</a> is an open-source and community-developed
Python package, which means that is only as good as the contribution of the
astronomical community. Clearly, there will always people who have more fun writing
code and others who have more fun using it. However, if you find a bug and do not
report it, then it is unlikely to be fixed. If you wish for a specific feature,
then you can either implement it and contribute it or at least fill in a feature
request.</p>
<p>If you want to get help or discuss issues with other Astropy users, you can
sign up for the <a class="reference external" href="http://mail.scipy.org/mailman/listinfo/astropy">astropy mailing list</a>.
Alternatively, the <a class="reference external" href="http://groups.google.com/group/astropy-dev">astropy-dev</a> list is where you should go to
discuss more technical aspects of Astropy with the developers.</p>
<p>If you have come across something that you believe is a bug, please open a
ticket in the Astropy <a class="reference external" href="http://github.com/astropy/astropy/issues">issue tracker</a>, and we will look into it
promptly.</p>
<p>Please try to include an example that demonstrates the issue and will allow the
developers to reproduce and fix the problem.  If you are seeing a crash
then frequently it will help to include the full Python stack trace as well as
information about your operating system (e.g. MacOSX version or Linux version).</p>
<p>Here is a practical example.
<a class="reference internal" href="#formula-vaccr"><em>Above</em></a> we calculated the free-fall
velocity onto MN Lup like this:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v_accr</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">G</span> <span class="o">*</span><span class="n">M_MN_Lup</span> <span class="o">/</span> <span class="n">R_MN_Lup</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
</pre></div>
</div>
<p>Mathematically, the following statement is equivalent:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">v_accr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="mf">2.</span><span class="o">*</span><span class="n">G</span> <span class="o">*</span> <span class="n">M_MN_Lup</span><span class="o">/</span><span class="n">R_MN_Lup</span><span class="p">))</span>
</pre></div>
</div>
<p>However, this raises a warning and automatically converts the quantity object
to an numpy array and the unit is lost. If you believe that is a bug that should
be fixed, you might chose to report it in the <a class="reference external" href="http://github.com/astropy/astropy/issues">issue tracker</a>.
(But please check if somebody else has reported the same thing before, so we do
not clutter the issue tracker needlessly.)</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper"><h3>Page Contents</h3>
<ul>
<li><a class="reference internal" href="#">Astropy II: Analyzing UVES Spectroscopy</a><ul>
<li><a class="reference internal" href="#before-you-proceed">Before you proceed</a></li>
<li><a class="reference internal" href="#acknowledgments">Acknowledgments</a></li>
<li><a class="reference internal" href="#scientific-background">Scientific background</a></li>
<li><a class="reference internal" href="#reading-the-data">Reading the data</a></li>
<li><a class="reference internal" href="#making-code-reusable-as-a-function">Making code reusable as a function</a></li>
<li><a class="reference internal" href="#units-and-constants-in-astropy">Units and constants in astropy</a></li>
<li><a class="reference internal" href="#converting-times">Converting times</a></li>
<li><a class="reference internal" href="#normalize-the-flux-to-the-local-continuum">Normalize the flux to the local continuum</a></li>
<li><a class="reference internal" href="#publication-ready-output">Publication ready output</a><ul>
<li><a class="reference internal" href="#tables">Tables</a></li>
<li><a class="reference internal" href="#plots">Plots</a></li>
</ul>
</li>
<li><a class="reference internal" href="#contributing-to-astropy">Contributing to Astropy</a></li>
</ul>
</li>
</ul>


  <h4>Previous topic</h4>
  <p class="topless"><a href="../astropy/coordinates.html"
                        title="previous chapter">Celestial Coordinates</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../vo/vo.html"
                        title="next chapter">Online Astronomy and the virtual observatory</a></p>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
<footer class="footer">
  <p class="pull-right">
    <a href="../_sources/astropy-UVES/UVES.txt"
       rel="nofollow">Page Source</a> &nbsp;
    <a href="#">Back to Top</a></p>
  <p>
    &copy; Copyright 2011-2015, Smithsonian Astrophysical Observatory under
    terms of <a rel="license"
                href="http://creativecommons.org/licenses/by/3.0/">CC
      Attribution 3.0</a>.<br/>
    Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.2.3. &nbsp;
</footer>
  </body>
</html>